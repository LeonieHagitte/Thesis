---
title: "Analysis"
author: "Leonie"
date: "2024-04-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# to clear environment while working
rm(list=ls()) 

usethis::use_git_config(
  user.name = "LeonieHagitte",
  user.email = "leonie.hagitte@student.hu-berlin.de",
  init.defaultBranch = "devl")

```

# Reproducibility 
```{r}
if(!requireNamespace("remotes"))
install.packages("remotes")
remotes::install_github("aaronpeikert/repro")
repro::automate() #creating a Dockerfile.    ####################### BUG ######
repro::use_docker()
repro::use_gha_docker() #GitHub action (GHA) is a cloud service that runs software when certain events trigger it.Add a GitHub Action to build the required Docker image with

# Install or update 'renv' package from CRAN if needed
# Load 'renv' package
library(renv)

# Initialize 'renv' in your project
renv::init()

# Activate the project-specific 'renv' environment
renv::activate()

# Install required packages for your project
#renv::install()

# Update renv.lock file
renv::snapshot()

```

# Model specification
```{r}
model <- "
# Measurement model
y1 =~ x1 + x2 + x3 + x4
y2 =~ x5 + x6 + x7 + x8
y3 =~ x9 + x10 + x11 + x12
y4 =~ x13 + x14 + x15 + x16
y5 =~ x17 + x18 + x19 + x20

# Factor variances
y1 ~~ y1
y2 ~~ y2
y3 ~~ y3
y4 ~~ y4
y5 ~~ y5

# Factor correlations
y1 ~~ y2
y1 ~~ y3
y1 ~~ y4
y1 ~~ y5
y2 ~~ y3
y2 ~~ y4
y2 ~~ y5
y3 ~~ y4
y3 ~~ y5
y4 ~~ y5
"

```

# Data Preparation
## Data enreading
```{r}
library(dplyr)
library(mice)

data <- read.csv('', 
    header = F)
#missing data are coded as -9999, recode to NA
data[data == -9999] <- NA
#I know you can do this in dplyr using some command
#but this is quick and basic
data2 <- dplyr::select(data, 2, 8:10) #change values
names(data2) <- c('X', 'X', 'X', 'X')


md.pattern(hsbwmiss2, rotate.names = T)

```
## NAs FIMLn
```{r}
library(lavaan)
model <- sem("
# Measurement model
y1 =~ x1 + x2 + x3 + x4
y2 =~ x5 + x6 + x7 + x8
y3 =~ x9 + x10 + x11 + x12
y4 =~ x13 + x14 + x15 + x16
y5 =~ x17 + x18 + x19 + x20

# Factor variances
y1 ~~ y1
y2 ~~ y2
y3 ~~ y3
y4 ~~ y4
y5 ~~ y5

# Factor correlations
y1 ~~ y2
y1 ~~ y3
y1 ~~ y4
y1 ~~ y5
y2 ~~ y3
y2 ~~ y4
y2 ~~ y5
y3 ~~ y4
y3 ~~ y5
y4 ~~ y5
", data = data)

summary(model)

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

# Poweranalyse
```{r}
install.packages('semPower')
devtools::install_github('martscht/stuart/stuart', ref = 'develop')
library(semPower)
library(stuart)
library(lavaan)
```

# Poweranalyse - SemPower ohne Model
```{r}
ap <- semPower.aPriori(effect = .05, effect.measure = 'RMSEA', 
                       alpha = .05, power = .80, df = 150)
summary(ap)
```

# Poweranalyse - SemPower mit Model
```{r}
powerLI <- semPower.powerLI(
  type = 'a-priori', alpha = .05, power = .80,
  comparison = 'configural',
  nullEffect = 'metric',
  nIndicator = c(4, 4, 4, 4, 4),
  loadM = c(.6, .7, .6, .7, .7),
  autocorResiduals = TRUE
)
# show summary
summary(powerLI)

```
## Results Printed
semPower: A priori power analysis

 Simulated power based on 500 successful replications.
 Note that simulated a-priori power analyses are only approximate,
 unless the number of replications is large.
                                               
                           Analytical Simulated
                                               
 F0                        0.029922   0.030359 
 RMSEA                     0.043245   0.043560 
 Mc                        0.985150   0.984935 
                                               
 df                        16         16       
 Required Num Observations 645        613      
                                               
 Critical Chi-Square       26.29622   26.29622 
 NCP                       19.26999   18.57971 
 Alpha                     0.050000   0.050000 
 Beta                      0.199943   0.212000 
 Power (1 - Beta)          0.800057   0.788000 
 Implied Alpha/Beta Ratio  0.250072   0.235849 


 Simulation Results:
                                                     
 Convergence Rate (%) of the H0 model        100.00  
                                                     
 Chi-Square Bias (%)                                 
 H0 Model                                    0.68    
 H1 Model                                    1.48    
 H0-H1 Difference                            -2.03   
                                                     
 Chi-Square KS-Distance                              
 H0 Model                                    0.017362
 H1 Model                                    0.027111
 H0-H1 Difference                            0.014788
                                                     
 Rejection Rate (%)                                  
 H0 Model                                    32.80   
 H1 Model                                    8.60    
                                                     
 Average Parameter Bias (%) in the H1 Model:         
 Loadings                                    0.06    
 Variances/Covariances                       0.00    

# Stuart - Item selection
## Sample split
```{r}
library(lavaan)
library(stuart)
###########################
data()

split <- holdout(data, prop = 0.5, grouping = NULL, seed = 2024, determined = NULL)
lapply(split, nrow) #check size of sample
kfold(
  type,
  k = 5,
  max.invariance = "configural",
  seed = 2024,
  seeded.search = TRUE,
  ...,
  remove.details = TRUE
)
###########################

fs <- list()

stuart::kfold(
  "gene",
  k = 5,
  data = ,
  factor.structure = fs,
  max.invariance = "configural",
  seed = 2024,
  seeded.search = TRUE,
  ...,
  remove.details = TRUE
)

```

## Genetic Algorithm
```{r}
library(stuart)
gene(
  data,                 # Your data frame containing the observed variables
  factor.structure,     # A list defining the factor structure of your model
  capacity = NULL,      # Optional, capacity constraint for factors
  item.weights = NULL,  # Optional, initial weights for each indicator
  item.invariance = "congeneric",  # Specify the type of invariance assumption for items
  repeated.measures = NULL,        # Optional, specify repeated measures design
  grouping = NULL,                 # Optional, specify grouping variable for multigroup analysis
  group.invariance = "strict",     # Specify the type of invariance assumption for multigroup analysis
  comparisons = NULL,              # Optional, specify comparisons for multigroup analysis
  auxiliary = NULL,                # Optional, specify auxiliary variables
  use.order = FALSE,               # Whether to use order constraints
  software = "lavaan",             # Specify the SEM software to be used
  cores = NULL,                    # Number of CPU cores to be used for parallel processing
  objective = NULL,                # Optional, specify a custom objective function
  ignore.errors = FALSE,           # Whether to ignore errors during fitness evaluation
  burnin = 5,                      # Number of generations for burn-in phase
  generations = 256,               # Total number of generations
  individuals = 64,                # Number of individuals in each generation
  selection = "tournament",        # Selection method for genetic algorithm
  selection.pressure = NULL,       # Pressure for tournament selection
  elitism = NULL,                  # Rate of elitism
  reproduction = 0.5,               # Proportion of individuals reproduced in each generation
  mutation = 0.05,                  # Mutation rate
  mating.index = 0,                 # Index of mating type
  mating.size = 0.25,               # Proportion of mating pool size
  mating.criterion = "similarity",  # Criterion for selecting mates
  immigration = 0,                  # Proportion of immigrants in each generation
  convergence.criterion = "geno.between",  # Convergence criterion
  tolerance = NULL,                 # Tolerance for convergence
  reinit.n = 1,                     # Number of reinitializations
  reinit.criterion = convergence.criterion,  # Criterion for reinitialization
  reinit.tolerance = NULL,          # Tolerance for reinitialization
  reinit.prop = 0.75,               # Proportion of population reinitialized
  schedule = "run",                 # Schedule for genetic algorithm
  analysis.options = NULL,          # Additional options for analysis
  suppress.model = FALSE,           # Whether to suppress model output
  seed = NULL,                      # Seed for random number generation
  filename = NULL                   # Optional, filename for saving results
)

```

## Objective-Function
```{r}
# threshhold for reliability
# correlations?
# variance in item difficulty - via intercepts??
# configural inveriance as aim, in light of heterogeneitity?


fixedobjective(
  criteria = c("rmsea", "srmr", "crel"),
  add = c("chisq", "df", "pvalue"),
  side = NULL, #can this be specified for certain values?
  scale = 1,
  matrices = NULL,
  fixed = NULL,
  comparisons = NULL,
  ...
)


```

## Crossvalidation
```{r}

crossvalidate(
  selection,split
)

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```
